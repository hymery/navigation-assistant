<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: Arial, sans-serif; 
            background: #000000; 
            color: #ffffff; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #000000;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #00ff00;
        }
        
        h1 {
            color: #00ff00;
            font-size: 28px;
            font-weight: bold;
        }
        
        .video-container {
            flex: 1;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #00ff00;
            margin: 10px;
            position: relative;
        }
        
        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .controls {
            padding: 20px;
            background: #000000;
        }
        
        .main-btn {
            width: 100%;
            padding: 25px;
            background: #00ff00;
            color: #000000;
            border: none;
            border-radius: 0;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .main-btn:disabled {
            background: #666666;
            color: #cccccc;
            cursor: not-allowed;
        }
        
        .status {
            background: #00ff00;
            color: #000000;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .warning {
            background: #ff0000;
            color: #ffffff;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            display: none;
        }

        .speaking-indicator {
            background: #0066ff;
            color: #ffffff;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            display: none;
        }

        .debug {
            background: #333333;
            color: #00ff00;
            padding: 10px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß≠ –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–ô –ü–û–ú–û–©–ù–ò–ö</h1>
    </div>
    
    <div class="video-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>
    
    <div class="controls">
        <button class="main-btn" id="mainBtn" disabled>–ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò...</button>
    </div>
    
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...</div>
    
    <div class="warning" id="warning"></div>

    <div class="speaking-indicator" id="speakingIndicator">
        üó£Ô∏è –û–∑–≤—É—á–∏–≤–∞—é –æ–∫—Ä—É–∂–µ–Ω–∏–µ...
    </div>

    <div class="debug" id="debug"></div>

    <audio id="audioPlayer" style="display: none;"></audio>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ TensorFlow —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    
    <script>
        // ==================== WEB AUDIO API –î–õ–Ø –†–ê–ë–û–¢–´ –°–û –ó–í–£–ö–û–ú ====================
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.audioElement = document.getElementById('audioPlayer');
                this.isAudioSupported = false;
                this.init();
            }


init() {
                try {
                    // –°–æ–∑–¥–∞–µ–º AudioContext –ø–æ—Å–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.isAudioSupported = true;
                    console.log('‚úÖ Web Audio API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (error) {
                    console.error('‚ùå Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', error);
                    this.isAudioSupported = false;
                }
            }

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ Web Audio API
            async playAudio(audioUrl) {
                if (!this.isAudioSupported) {
                    // –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    return this.playStandardAudio(audioUrl);
                }

                try {
                    // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ
                    const response = await fetch(audioUrl);
                    const arrayBuffer = await response.arrayBuffer();
                    
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    const source = this.audioContext.createBufferSource();
                    const gainNode = this.audioContext.createGain();
                    
                    source.buffer = audioBuffer;
                    gainNode.gain.value = 1.0; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ü–µ–ø–æ—á–∫—É: –∏—Å—Ç–æ—á–Ω–∏–∫ -> –≥—Ä–æ–º–∫–æ—Å—Ç—å -> –≤—ã—Ö–æ–¥
                    source.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
                    source.start(0);
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–º–∏—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    return new Promise((resolve) => {
                        source.onended = () => {
                            console.log('üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                            resolve();
                        };
                    });
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ Web Audio API:', error);
                    // –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    return this.playStandardAudio(audioUrl);
                }
            }

            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTML5 Audio
            playStandardAudio(audioUrl) {
                return new Promise((resolve, reject) => {
                    this.audioElement.src = audioUrl;
                    this.audioElement.play()
                        .then(() => {
                            this.audioElement.onended = () => resolve();
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                            reject(error);
                        });
                });
            }
        }

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ù–´–ô SPEECH SYNTHESIZER –° WEB AUDIO API ====================
        class SpeechSynthesizer {
            constructor() {
                this.isSpeaking = false;
                this.audioPlayer = document.getElementById('audioPlayer');
                this.speakingIndicator = document.getElementById('speakingIndicator');
                this.audioManager = new AudioManager();
            }

            getSpeechKitConfig() {
                return {
                    apiUrl: 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize',
                    folderId: 'b1gj8glojqbh843o2iq5',
                    iamToken: 'ajenblfsa0oup3hjtv7i'
                };
            }

            getVoiceSettings() {
                return {
                    voice: 'alena',
                    emotion: 'good',
                    speed: '0.9'
                };
            }

            async speakText(text) {
                if (this.isSpeaking) return;
                
                this.isSpeaking = true;
                this.showSpeakingIndicator(true);

                try {
                    // –ü—Ä–æ–±—É–µ–º Yandex SpeechKit —Å Web Audio API
                    await this.synthesizeWithYandex(text);
                } catch (error) {
                    console.warn('Yandex SpeechKit –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                    // –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–µ–∑
                    this.fallbackSpeak(text);
                } finally {
                    this.isSpeaking = false;
                    this.showSpeakingIndicator(false);
                }
            }

            async synthesizeWithYandex(text) {
                const config = this.getSpeechKitConfig();
                const voiceSettings = this.getVoiceSettings();

                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': Bearer ${config.iamToken},
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'text': text,
                        'voice': voiceSettings.voice,
                        'emotion': voiceSettings.emotion,
                        'speed': voiceSettings.speed,
                        'folderId': config.folderId,
                        'format': 'oggopus'
                    })
                });

                if (!response.ok) {
                    throw new Error(SpeechKit error: ${response.status});
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ Web Audio API
                await this.audioManager.playAudio(audioUrl);
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL
                URL.revokeObjectURL(audioUrl);
            }

            fallbackSpeak(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ru-RU';
                    utterance.rate = 0.9;
                    utterance.pitch = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }

            showSpeakingIndicator(show) {
                if (this.speakingIndicator) {
                    this.speakingIndicator.style.display = show ? 'block' : 'none';
                }
            }

            // –ë—ã—Å—Ç—Ä–∞—è –æ–∑–≤—É—á–∫–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
            quickSpeak(text) {
                if (this.isSpeaking) return;
                
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ru-RU';
                    utterance.rate = 0.9;
                    speechSynthesis.speak(utterance);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–∑–≤—É—á–∫–∏
        let speechSynthesizer;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App

if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä —Å Web Audio API
        speechSynthesizer = new SpeechSynthesizer();
        window.speechSynthesizer = speechSynthesizer;
        
        console.log("‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–∑–≤—É—á–∫–∏ —Å Web Audio API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");

        // –¢–µ—Å—Ç –æ–∑–≤—É—á–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            if (speechSynthesizer) {
                speechSynthesizer.quickSpeak('–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
            }
        }, 2000);
    </script>

    <script src="app.js"></script>
</body>
</html>
