<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: Arial, sans-serif; 
            background: #000000; 
            color: #ffffff; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #000000;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #00ff00;
        }
        
        h1 {
            color: #00ff00;
            font-size: 28px;
            font-weight: bold;
        }
        
        .video-container {
            flex: 1;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #00ff00;
            margin: 10px;
            position: relative;
        }
        
        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .controls {
            padding: 20px;
            background: #000000;
        }
        
        .main-btn {
            width: 100%;
            padding: 25px;
            background: #00ff00;
            color: #000000;
            border: none;
            border-radius: 0;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .main-btn:disabled {
            background: #666666;
            color: #cccccc;
            cursor: not-allowed;
        }
        
        .status {
            background: #00ff00;
            color: #000000;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .warning {
            background: #ff0000;
            color: #ffffff;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            display: none;
        }

        .speaking-indicator {
            background: #0066ff;
            color: #ffffff;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            display: none;
        }

        .debug {
            background: #333333;
            color: #00ff00;
            padding: 10px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß≠ –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–ô –ü–û–ú–û–©–ù–ò–ö</h1>
    </div>
    
    <div class="video-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>
    
    <div class="controls">
        <button class="main-btn" id="mainBtn" disabled>–ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò...</button>
    </div>
    
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...</div>
    
    <div class="warning" id="warning"></div>

    <div class="speaking-indicator" id="speakingIndicator">
        üó£Ô∏è –û–∑–≤—É—á–∏–≤–∞—é –æ–∫—Ä—É–∂–µ–Ω–∏–µ...
    </div>

    <div class="debug" id="debug"></div>

    <audio id="audioPlayer" style="display: none;"></audio>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ TensorFlow —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    
    <script>
        // ==================== –°–ò–°–¢–ï–ú–ê –û–ó–í–£–ß–ö–ò ====================
        class SpeechSynthesizer {
            constructor() {
                this.isSpeaking = false;
                this.audioContext = null;
                this.audioPlayer = document.getElementById('audioPlayer');
                this.speakingIndicator = document.getElementById('speakingIndicator');
            }


getSpeechKitConfig() {
                return {
                    apiUrl: 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize',
                    folderId: 'b1gj8glojqbh843o2iq5',
                    iamToken: 'ajenblfsa0oup3hjtv7i'
                };
            }

            getVoiceSettings() {
                return {
                    voice: 'alena',
                    emotion: 'good',
                    speed: '0.9'
                };
            }

            async speakText(text) {
                if (this.isSpeaking) return;
                
                this.isSpeaking = true;
                this.showSpeakingIndicator(true);

                try {
                    // –ü—Ä–æ–±—É–µ–º Yandex SpeechKit
                    await this.synthesizeWithYandex(text);
                } catch (error) {
                    console.warn('Yandex SpeechKit –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                    // –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–µ–∑
                    this.fallbackSpeak(text);
                } finally {
                    this.isSpeaking = false;
                    this.showSpeakingIndicator(false);
                }
            }

            async synthesizeWithYandex(text) {
                const config = this.getSpeechKitConfig();
                const voiceSettings = this.getVoiceSettings();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
                if (config.folderId === 'YOUR_FOLDER_ID' || config.iamToken === 'YOUR_IAM_TOKEN') {
                    throw new Error('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Yandex SpeechKit —Ç–æ–∫–µ–Ω—ã');
                }

                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': Bearer ${config.iamToken},
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'text': text,
                        'voice': voiceSettings.voice,
                        'emotion': voiceSettings.emotion,
                        'speed': voiceSettings.speed,
                        'folderId': config.folderId,
                        'format': 'oggopus'
                    })
                });

                if (!response.ok) {
                    throw new Error(SpeechKit error: ${response.status});
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                this.audioPlayer.src = audioUrl;
                await this.audioPlayer.play();
                
                await new Promise((resolve) => {
                    this.audioPlayer.onended = resolve;
                });
            }

            fallbackSpeak(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ru-RU';
                    utterance.rate = 0.9;
                    utterance.pitch = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }

            showSpeakingIndicator(show) {
                this.speakingIndicator.style.display = show ? 'block' : 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–∑–≤—É—á–∫–∏
        let speechSynthesizer;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä
        speechSynthesizer = new SpeechSynthesizer();
        window.speechSynthesizer = speechSynthesizer;
        
        console.log("‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–∑–≤—É—á–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
    </script>

    <script src="app.js"></script>
</body>
</html>
